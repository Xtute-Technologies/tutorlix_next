pipeline {
    agent any

    // 1. Define Parameters
    parameters {
        choice(
            name: 'DEPLOY_SCOPE', 
            choices: ['All', 'Frontend', 'Backend'], 
            description: 'Choose which components to build and deploy.'
        )
    }

    environment {
        FRONTEND_DIR = "${WORKSPACE}/frontend"
        BACKEND_DIR  = "${WORKSPACE}/backend"

        NEXT_APP_NAME = "tutorlix-next"
        NEXT_PORT     = "3701" 

        DJANGO_SETTINGS_MODULE = "tutorlix.settings"
        NEXT_PUBLIC_API_URL = "https://tutorlix.com"
    }

    stages {

        /* ================= CHECKOUT (Always Runs) ================= */
        stage('Checkout') {
            steps {
                echo "üöÄ Starting deploy. Scope: ${params.DEPLOY_SCOPE}"
                checkout scm
            }
        }

        /* ================= FRONTEND STAGES ================= */
        
        stage('Build Next.js (CI)') {
            // Run if Scope is All OR Frontend
            when { 
                expression { return params.DEPLOY_SCOPE == 'All' || params.DEPLOY_SCOPE == 'Frontend' } 
            }
            steps {
                sh '''
                    cd $FRONTEND_DIR

                    echo "üßπ Cleaning old build"
                    rm -rf node_modules .next

                    echo "üì¶ Installing deps"
                    npm install

                    # Ensure PM2 is installed globally
                    sudo npm install -g pm2

                    echo "üèóÔ∏è Building Next.js with API URL: $NEXT_PUBLIC_API_URL"
                    NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL npm run build
                '''
            }
        }

        stage('Start / Restart Next.js (PM2)') {
            when { 
                expression { return params.DEPLOY_SCOPE == 'All' || params.DEPLOY_SCOPE == 'Frontend' } 
            }
            steps {
                sh '''
                    cd $FRONTEND_DIR
                    
                    PM2_CMD="sudo /usr/bin/pm2"
                    
                    echo "üîÅ Managing PM2 Process: $NEXT_APP_NAME on Port $NEXT_PORT"

                    # Check if the process exists in the PM2 list
                    if $PM2_CMD list | grep -q "$NEXT_APP_NAME"; then
                        echo "‚úÖ Process found. Reloading with --update-env..."
                        sudo PORT=$NEXT_PORT $PM2_CMD reload $NEXT_APP_NAME --update-env
                    else
                        echo "‚ú® Process not found. Starting new..."
                        sudo PORT=$NEXT_PORT $PM2_CMD start npm --name "$NEXT_APP_NAME" -- start
                    fi

                    echo "üíæ Saving PM2 process list to allow auto-resurrection..."
                    $PM2_CMD save
                '''
            }
        }

        /* ================= BACKEND STAGES ================= */

        stage('Backend Setup') {
            // Run if Scope is All OR Backend
            when { 
                expression { return params.DEPLOY_SCOPE == 'All' || params.DEPLOY_SCOPE == 'Backend' } 
            }
            steps {
                sh '''
                    cd $BACKEND_DIR

                    echo "üêç Backend setup"
                    python3 -m venv venv || true
                    . venv/bin/activate

                    pip install --upgrade pip
                    pip install -r requirements.txt
                    pip install gunicorn

                    export DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE
                    python manage.py migrate || true
                    python manage.py collectstatic --noinput || true
                '''
            }
        }

        stage('Start / Restart Gunicorn') {
            when { 
                expression { return params.DEPLOY_SCOPE == 'All' || params.DEPLOY_SCOPE == 'Backend' } 
            }
            steps {
                sh '''
                    echo "üîÅ Restarting Tutorlix Gunicorn Service"
                    # Assuming you have a systemd service file named tutorlix-gunicorn
                    sudo systemctl restart tutorlix-gunicorn
                '''
            }
        }

        /* ================= NGINX (Always Runs) ================= */
        // We reload Nginx regardless of scope to ensure routing is clean
        stage('Reload Nginx') {
            steps {
                sh '''
                    echo "üîÑ Reloading nginx configuration"
                    sudo nginx -t && sudo systemctl reload nginx
                '''
            }
        }
    }

    post {
        success {
            echo "‚úÖ Jenkins deploy ($params.DEPLOY_SCOPE) succeeded"
        }
        failure {
            echo "‚ùå Jenkins deploy ($params.DEPLOY_SCOPE) failed"
        }
    }
}