pipeline {
  agent any

  environment {
    FRONTEND_DIR = "${WORKSPACE}/frontend"
    BACKEND_DIR  = "${WORKSPACE}/backend"

    NEXT_APP_NAME = "tutorlix-next"
    NEXT_PORT     = "3000"

    DJANGO_SETTINGS_MODULE = "tutorlix.settings"
  }

  stages {

    /* ================= CHECKOUT ================= */

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    /* ================= FRONTEND ================= */

    stage('Build Next.js (CI)') {
      steps {
        sh '''
          cd $FRONTEND_DIR

          echo "ğŸ§¹ Cleaning old build"
          rm -rf node_modules .next

          echo "ğŸ“¦ Installing deps"
          npm install
          sudo npm install -g pm2
          pm2 -v
          which pm2
          echo "ğŸ—ï¸ Building Next.js"
          npm run build
        '''
      }
    }

    /* ================= BACKEND ================= */

    stage('Backend Setup') {
      steps {
        sh '''
          cd $BACKEND_DIR

          echo "ğŸ Backend setup"
          python3 -m venv venv || true
          . venv/bin/activate

          pip install --upgrade pip
          pip install -r requirements.txt

          export DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE
          python manage.py migrate || true
        '''
      }
    }

    /* ================= START SERVICES ================= */

   stage('Start / Restart Next.js (PM2)') {
        steps {
            sh '''
                cd $FRONTEND_DIR

                echo "ğŸ” Restarting Next.js with PM2"

                PM2=/usr/bin/pm2

                if $PM2 describe tutorlix-next > /dev/null; then
                    $PM2 reload tutorlix-next --update-env
                else
                    $PM2 start npm --name tutorlix-next -- start
                fi

                $PM2 save
            '''
        }
    }

    stage('Start / Restart Gunicorn') {
      steps {
        sh '''
          cd $BACKEND_DIR
          . venv/bin/activate

          echo "ğŸ” Restarting Gunicorn"
          pkill gunicorn || true

          export DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE

          nohup gunicorn \
            --workers 3 \
            --bind 127.0.0.1:8000 \
            core.wsgi:application \
            > gunicorn.log 2>&1 &
        '''
      }
    }

    /* ================= NGINX ================= */

    stage('Reload Nginx') {
      steps {
        sh '''
          echo "ğŸ”„ Reloading nginx"
          nginx -t && systemctl reload nginx
        '''
      }
    }
  }

  post {
    success {
      echo 'âœ… Jenkins deploy succeeded'
    }
    failure {
      echo 'âŒ Jenkins deploy failed'
    }
  }
}
