pipeline {
    agent any

    environment {
        REPO_URL = 'git@github.com:Xtute-Technologies/tutorlix_next.git'
        BRANCH   = 'main'    // change if your branch is different
        DEPLOY_PATH = '/srv/tutorlix/frontend/tutorlix_next'
        COMPOSE_FILE = 'docker-compose.yml'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: "${BRANCH}", credentialsId: 'github-ssh-key', url: "${REPO_URL}"
            }
        }

        stage('Sync & Deploy') { // Renamed stage for clarity
            steps {
                sh """
                    echo "Syncing new code to deployment directory..."
                    # Running rsync with sudo to overcome file permission issues in the destination directory.
                    sudo rsync -rlpv --delete ./ ${DEPLOY_PATH}/

                    echo "Deploying Next.js app..."
                    # Running docker compose with sudo in case the Jenkins user is not in the docker group.
                    sudo docker compose -f ${DEPLOY_PATH}/${COMPOSE_FILE} down
                    sudo docker compose -f ${DEPLOY_PATH}/${COMPOSE_FILE} build --no-cache
                    sudo docker compose -f ${DEPLOY_PATH}/${COMPOSE_FILE} up -d
                """
            }
        }

        stage('Restart Nginx') {
            steps {
                sh """
                    echo "Restarting Nginx..."
                    sudo systemctl restart nginx
                """
            }
        }
    }

    post {
        success {
            echo "✅ Deployment completed successfully at https://xtute.com"
        }
        failure {
            echo "❌ Deployment failed"
        }
    }
}

