pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
    }

    environment {
        REPO_URL = 'git@github.com:Xtute-Technologies/tutorlix_next.git'
        BRANCH   = 'main'

        BASE_PATH     = '/srv/tutorlix'
        FRONTEND_PATH = '/srv/tutorlix/frontend'
        BACKEND_PATH  = '/srv/tutorlix/backend'

        NODE_ENV = 'production'
        DJANGO_SETTINGS_MODULE = 'core.settings.production'
    }

    stages {

        /* ================= CHECKOUT ================= */
        stage('Checkout') {
            steps {
                deleteDir()
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${BRANCH}"]],
                    userRemoteConfigs: [[
                        url: "${REPO_URL}",
                        credentialsId: 'github-ssh-key'
                    ]]
                ])
            }
        }

        /* ================= FRONTEND ================= */
        stage('Frontend â€“ Install') {
            steps {
                sh '''
                    cd frontend
                    npm ci
                '''
            }
        }

        stage('Frontend â€“ Lint') {
            steps {
                sh '''
                    cd frontend

                    echo "ğŸ”§ Preparing ESLint config for CI"

                    # Remove flat config to avoid ESLint v9
                    rm -f eslint.config.mjs

                    # Create minimal ESLint config if none exists (non-interactive)
                    if [ ! -f .eslintrc.json ]; then
                    cat > .eslintrc.json << 'EOF'
        {
        "extends": ["next/core-web-vitals"]
        }
        EOF
                    fi

                    # Ensure compatible ESLint version
                    npm install --save-dev eslint@8 eslint-config-next@14

                    # Run lint NON-interactively
                    npx next lint --no-interactive
                '''
            }
        }

        stage('Frontend â€“ Tests') {
            steps {
                sh '''
                    cd frontend
                    npm test -- --watch=false
                '''
            }
        }

        stage('Frontend â€“ Build') {
            steps {
                sh '''
                    cd frontend
                    npm run build
                '''
            }
        }

        /* ================= BACKEND ================= */
        stage('Backend â€“ Setup') {
            steps {
                sh '''
                    cd backend
                    python3 -m venv venv || true
                    source venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }

        stage('Backend â€“ Lint') {
            steps {
                sh '''
                    cd backend
                    source venv/bin/activate
                    flake8 .
                '''
            }
        }

        stage('Backend â€“ Tests') {
            steps {
                sh '''
                    cd backend
                    source venv/bin/activate
                    python manage.py test
                '''
            }
        }

        /* ================= DEPLOY ================= */
        stage('Sync Code to Server') {
            steps {
                sh '''
                    sudo rsync -rlpv --delete \
                      --exclude=node_modules \
                      --exclude=.next \
                      frontend/ ${FRONTEND_PATH}/

                    sudo rsync -rlpv --delete \
                      --exclude=venv \
                      --exclude=__pycache__ \
                      backend/ ${BACKEND_PATH}/
                '''
            }
        }

        stage('Backend â€“ Migrate & Collectstatic') {
            steps {
                sh '''
                    cd ${BACKEND_PATH}
                    source venv/bin/activate
                    python manage.py migrate --noinput
                    python manage.py collectstatic --noinput
                '''
            }
        }

        stage('Restart Services') {
            steps {
                sh '''
                    sudo systemctl restart gunicorn
                    pm2 reload frontend || pm2 start npm --name frontend -- start
                    sudo systemctl restart nginx
                '''
            }
        }
    }

    post {
        success {
            echo "âœ… Lint + Tests passed. Deployment successful ğŸš€"
        }
        failure {
            echo "âŒ Lint/Test failed. Deployment aborted"
        }
    }
}
